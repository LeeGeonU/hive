{% extends "base.html" %}

{% block title %} timeline {% endblock %}

{% block content %}
	<p><p><p><p>
	<link rel="stylesheet" href="{{ STATIC_URL }}css/redactor.css" />
	<!-- Post Form -->
	<p>
		<form action="/posts/create_from_timeline/" method="post">{% csrf_token %}
			say something! : </br> 
    		<textarea id="redactor_content" name="post_contents"></textarea>
    		<input type="submit" value="POST">
    	</form>
    </p>
    
    <!-- timeline -->				
    <div id="timeline_container">
	{% include "timelines/timeline_timeline.html" %}
    </div>
    <!--
	<button id="loadmore" class="btn-large btn-block btn"> LoadMore </button>
	-->
	<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.8.0.min.js"></script>
	<script src="{{ STATIC_URL }}js/redactor.js"></script>
	<script> 
		var last_timeline_id = {{ last_timeline_id }} ;
		$(document).ready(
			function()
			{

				$(window).scroll(function(){
    				if($(window).scrollTop() == $(document).height() - $(window).height()){
        				{% if is_maintimeline_active %}
						var req_url='/timelines/get_more_timeline/'+last_timeline_id + '/'
						{% elif is_humortimeline_active %}
						var req_url='/timelines/humor_timeline/'+last_timeline_id + '/'
						{% elif is_noticetimeline_active %}
						var req_url='/timelines/notice_timeline/'+last_timeline_id + '/'
						{% endif %}
						$.get(req_url,function(data){
							if(data){
								$("#timeline_container").append(data);
							}else{
								$("#timeline_container").append("더 이상 표시할 포스트가 없습니다.");
							}
						});
        		    }	
				});

				$("form textarea").redactor({
				    imageUpload: '{% url posts.views.upload_photos %}',
				    imageGetJson: '{% url posts.views.recent_photos %}'
				});
				/*
				$("#loadmore").click(function(){
					// http://127.0.0.1:8000/timelines/get_more_timeline/100/
					// timeline_container
					{% if is_maintimeline_active %}
					var req_url='/timelines/get_more_timeline/'+last_timeline_id + '/'
					{% elif is_humortimeline_active %}
					var req_url='/timelines/humor_timeline/'+last_timeline_id + '/'
					{% elif is_noticetimeline_active %}
					var req_url='/timelines/notice_timeline/'+last_timeline_id + '/'
					{% endif %}
					
						$.get(req_url,function(data){
							$("#timeline_container").append(data)
						})
				})
				*/
			function ajax_comment(event){
				  var post_id_regex =  /posts\/create_comment\/(\d+)\//;
				  var post_id = this.action.match(post_id_regex)[1]
				  var action = this.action;
				  var container_id = "div#post_container_" + post_id;
				  // get all variable
				  var a = $(this);
				  var comment = $(a[0][1]).val();
				  var csrf = $(a[0][0]).val();
			 	$.post(action, {
			       	"csrfmiddlewaretoken": csrf,
			       	"comment_text": comment },
			       function(data){
			        $(container_id).html(data)
			        var new_csrf = $(data).children("input[name=csrfmiddlewaretoken]")[0].value;
			         $("input[name=csrfmiddlewaretoken").val(new_csrf);
				
			       });
					event.preventDefault();
				}

				// attach comment submit event to form.comment
				$("body").on("submit","form.comment", ajax_comment)
			}
		);
	</script>
{% endblock %}
